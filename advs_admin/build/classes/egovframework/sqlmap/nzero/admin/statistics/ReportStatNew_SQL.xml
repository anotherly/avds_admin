<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ReportStatNew">

	<typeAlias  alias="paramMap" type="java.util.Map"/>
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>

	<!-- 보고서 통계 : 임시운행 등록번호 기준 -->
	<select id="ReportStatNewDAO.selectReportStatNewListByNum" parameterClass="paramMap" resultClass="egovMap">
		<![CDATA[
		SELECT
			FN_CT_GET_AGENCY_NAME(B.USER_ID) AS TRN	/* 임시운행기관 */
			, A.TMP_RACE_NUMBER						/* 임시운행등록번호 */
			, B.BUSI_CD	/* 분야코드 */
			, B.BUSI_NM	/* 분야명 */
			, C.TOTAL_DRIVING_DIST LAST_TOTAL_DRIVING_DIST	/* 전반기까지(누적) : 총주행거리*/
			, C.AUTO_DRIVING_DIST LAST_AUTO_DRIVING_DIST	/* 전반기까지(누적) : 자율모드 */
			, C.NOMAL_DRIVING_DIST LAST_NOMAL_DRIVING_DIST	/* 전반기까지(누적) : 일반모드 */
			, D.LAST_TOTAL_CTR_CHANGE_CNT 	/* 전반기까지(누적) : 제어권 전환 */
			, E.TOTAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 총주행거리 */
			, E.AUTO_DRIVING_DIST	/* 해당년도 반기 주행거리 : 자율모드 */
			, E.NOMAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 일반모드 */
			, F.AUTO_DRIVING_DIST_1
			, F.AUTO_DRIVING_DIST_2
			, F.AUTO_DRIVING_DIST_3
			, F.AUTO_DRIVING_DIST_4
			, F.AUTO_DRIVING_DIST_5
			, F.AUTO_DRIVING_DIST_6
			, F.AUTO_DRIVING_DIST_1 + F.AUTO_DRIVING_DIST_2 + F.AUTO_DRIVING_DIST_3 + F.AUTO_DRIVING_DIST_4 + F.AUTO_DRIVING_DIST_5 + F.AUTO_DRIVING_DIST_6 AS AUTO_DRIVING_SUM
			, G.CTR_CHANGE_CNT_1
			, G.CTR_CHANGE_CNT_2
			, G.CTR_CHANGE_CNT_3
			, G.CTR_CHANGE_CNT_4
			, G.CTR_CHANGE_CNT_5
			, G.CTR_CHANGE_CNT_6
			, G.CTR_CHANGE_CNT_1 + G.CTR_CHANGE_CNT_2 + G.CTR_CHANGE_CNT_3 + G.CTR_CHANGE_CNT_4 + G.CTR_CHANGE_CNT_5 + G.CTR_CHANGE_CNT_6 AS CTR_CHANGE_SUM
		FROM
			TB_CL_HT_DRIVING A
		INNER JOIN
			TB_CM_HT_TEMPOPER B
		ON
			A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
		
		/* 전반기까지(누적) : 총주행거리, 자율모드, 일반모드 */
		LEFT OUTER JOIN
		(
			SELECT
				A.TMP_RACE_NUMBER
				, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
				, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
				, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
			FROM
				TB_CL_HT_DRIVING A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			WHERE
				1=1
				AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
			GROUP BY A.TMP_RACE_NUMBER
		) C
		ON A.TMP_RACE_NUMBER = C.TMP_RACE_NUMBER
		
		/* 전반기까지(누적) : 제어권 전환 */
		LEFT OUTER JOIN
		(
			SELECT
				A.TMP_RACE_NUMBER
				, SUM(CTR_CHANGE_CNT) LAST_TOTAL_CTR_CHANGE_CNT
			FROM
				TB_CL_HT_CTRCHANGE A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			WHERE
				1=1
				AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
			GROUP BY A.TMP_RACE_NUMBER
		) D
		ON A.TMP_RACE_NUMBER = D.TMP_RACE_NUMBER
		
		/* 해당년도 반기 주행거리 : 총주행거리, 자율모드, 일반모드 */
		LEFT OUTER JOIN
		(
			SELECT
				A.TMP_RACE_NUMBER
				, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
				, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
				, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
			FROM
				TB_CL_HT_DRIVING A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			WHERE
				1=1
				AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
			GROUP BY A.TMP_RACE_NUMBER
		) E
		ON A.TMP_RACE_NUMBER = E.TMP_RACE_NUMBER
		
		/* 해당년도 반기  : 월별 자율주행 주행거리 */
		LEFT OUTER JOIN
		(
			SELECT
				A.TMP_RACE_NUMBER
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____01' OR DRIVING_DIST_MON LIKE '____07' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_1
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____02' OR DRIVING_DIST_MON LIKE '____08' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_2
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____03' OR DRIVING_DIST_MON LIKE '____09' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_3
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____04' OR DRIVING_DIST_MON LIKE '____10' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_4
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____05' OR DRIVING_DIST_MON LIKE '____11' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_5
				, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____06' OR DRIVING_DIST_MON LIKE '____12' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_6
			FROM
				TB_CL_HT_AUTODRIVING A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			WHERE
				1=1
				AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
			GROUP BY A.TMP_RACE_NUMBER
		) F
		ON A.TMP_RACE_NUMBER = F.TMP_RACE_NUMBER
		
		/* 해당년도 반기  : 제어권 전환 횟수 */
		LEFT OUTER JOIN 
		(
			SELECT
				A.TMP_RACE_NUMBER
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____01' OR CTR_CHANGE_MON LIKE '____07' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_1
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____02' OR CTR_CHANGE_MON LIKE '____08' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_2
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____03' OR CTR_CHANGE_MON LIKE '____09' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_3
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____04' OR CTR_CHANGE_MON LIKE '____10' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_4
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____05' OR CTR_CHANGE_MON LIKE '____11' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_5
				, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____06' OR CTR_CHANGE_MON LIKE '____12' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_6
			FROM
				TB_CL_HT_CTRCHANGE A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER	
			WHERE
				1=1
				AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
				GROUP BY A.TMP_RACE_NUMBER
		) G
		ON
			A.TMP_RACE_NUMBER = G.TMP_RACE_NUMBER
		WHERE
			IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) <= '$sKeyword$$sTerm$'
		]]>
		<isNotEmpty property="sTmpRaceAgency">
			AND A.TMP_RACE_AGENCY LIKE '%$sTmpRaceAgency$%'
		</isNotEmpty>
		<isNotEmpty property="sTmpRaceNumber">
			AND A.TMP_RACE_NUMBER LIKE '%$sTmpRaceNumber$%'
		</isNotEmpty>
		GROUP BY TRN, A.TMP_RACE_NUMBER
		ORDER BY A.TMP_RACE_NUMBER
	</select>
	
	<!-- 보고서 통계 : 기관 기준 -->
	<select id="ReportStatNewDAO.selectReportStatNewListByTrn" parameterClass="paramMap" resultClass="egovMap">
		<!-- WITH는 위와 똑같으면 됨 -->
		WITH TBL AS
		(
			<![CDATA[
			SELECT
				FN_CT_GET_AGENCY_NAME(B.USER_ID) AS TRN	/* 임시운행기관 */
				, A.TMP_RACE_NUMBER						/* 임시운행등록번호 */
				, B.BUSI_CD	/* 분야코드 */
				, B.BUSI_NM	/* 분야명 */
				, C.TOTAL_DRIVING_DIST LAST_TOTAL_DRIVING_DIST	/* 전반기까지(누적) : 총주행거리*/
				, C.AUTO_DRIVING_DIST LAST_AUTO_DRIVING_DIST	/* 전반기까지(누적) : 자율모드 */
				, C.NOMAL_DRIVING_DIST LAST_NOMAL_DRIVING_DIST	/* 전반기까지(누적) : 일반모드 */
				, D.LAST_TOTAL_CTR_CHANGE_CNT 	/* 전반기까지(누적) : 제어권 전환 */
				, E.TOTAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 총주행거리 */
				, E.AUTO_DRIVING_DIST	/* 해당년도 반기 주행거리 : 자율모드 */
				, E.NOMAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 일반모드 */
				, F.AUTO_DRIVING_DIST_1
				, F.AUTO_DRIVING_DIST_2
				, F.AUTO_DRIVING_DIST_3
				, F.AUTO_DRIVING_DIST_4
				, F.AUTO_DRIVING_DIST_5
				, F.AUTO_DRIVING_DIST_6
				, F.AUTO_DRIVING_DIST_1 + F.AUTO_DRIVING_DIST_2 + F.AUTO_DRIVING_DIST_3 + F.AUTO_DRIVING_DIST_4 + F.AUTO_DRIVING_DIST_5 + F.AUTO_DRIVING_DIST_6 AS AUTO_DRIVING_SUM
				, G.CTR_CHANGE_CNT_1
				, G.CTR_CHANGE_CNT_2
				, G.CTR_CHANGE_CNT_3
				, G.CTR_CHANGE_CNT_4
				, G.CTR_CHANGE_CNT_5
				, G.CTR_CHANGE_CNT_6
				, G.CTR_CHANGE_CNT_1 + G.CTR_CHANGE_CNT_2 + G.CTR_CHANGE_CNT_3 + G.CTR_CHANGE_CNT_4 + G.CTR_CHANGE_CNT_5 + G.CTR_CHANGE_CNT_6 AS CTR_CHANGE_SUM
			FROM
				TB_CL_HT_DRIVING A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			
			/* 전반기까지(누적) : 총주행거리, 자율모드, 일반모드 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
					, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
					, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
				FROM
					TB_CL_HT_DRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
				GROUP BY A.TMP_RACE_NUMBER
			) C
			ON A.TMP_RACE_NUMBER = C.TMP_RACE_NUMBER
			
			/* 전반기까지(누적) : 제어권 전환 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CTR_CHANGE_CNT) LAST_TOTAL_CTR_CHANGE_CNT
				FROM
					TB_CL_HT_CTRCHANGE A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
				GROUP BY A.TMP_RACE_NUMBER
			) D
			ON A.TMP_RACE_NUMBER = D.TMP_RACE_NUMBER
			
			/* 해당년도 반기 주행거리 : 총주행거리, 자율모드, 일반모드 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
					, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
					, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
				FROM
					TB_CL_HT_DRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
				GROUP BY A.TMP_RACE_NUMBER
			) E
			ON A.TMP_RACE_NUMBER = E.TMP_RACE_NUMBER
			
			/* 해당년도 반기  : 월별 자율주행 주행거리 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____01' OR DRIVING_DIST_MON LIKE '____07' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_1
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____02' OR DRIVING_DIST_MON LIKE '____08' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_2
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____03' OR DRIVING_DIST_MON LIKE '____09' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_3
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____04' OR DRIVING_DIST_MON LIKE '____10' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_4
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____05' OR DRIVING_DIST_MON LIKE '____11' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_5
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____06' OR DRIVING_DIST_MON LIKE '____12' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_6
				FROM
					TB_CL_HT_AUTODRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
				GROUP BY A.TMP_RACE_NUMBER
			) F
			ON A.TMP_RACE_NUMBER = F.TMP_RACE_NUMBER
			
			/* 해당년도 반기  : 제어권 전환 횟수 */
			LEFT OUTER JOIN 
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____01' OR CTR_CHANGE_MON LIKE '____07' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_1
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____02' OR CTR_CHANGE_MON LIKE '____08' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_2
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____03' OR CTR_CHANGE_MON LIKE '____09' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_3
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____04' OR CTR_CHANGE_MON LIKE '____10' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_4
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____05' OR CTR_CHANGE_MON LIKE '____11' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_5
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____06' OR CTR_CHANGE_MON LIKE '____12' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_6
				FROM
					TB_CL_HT_CTRCHANGE A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER	
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
					GROUP BY A.TMP_RACE_NUMBER
			) G
			ON
				A.TMP_RACE_NUMBER = G.TMP_RACE_NUMBER
			WHERE
				IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) <= '$sKeyword$$sTerm$'
			]]>
			<isNotEmpty property="sTmpRaceAgency">
				AND A.TMP_RACE_AGENCY LIKE '%$sTmpRaceAgency$%'
			</isNotEmpty>
			<isNotEmpty property="sTmpRaceNumber">
				AND A.TMP_RACE_NUMBER LIKE '%$sTmpRaceNumber$%'
			</isNotEmpty>
			GROUP BY TRN, A.TMP_RACE_NUMBER
			ORDER BY A.TMP_RACE_NUMBER
		)
		SELECT
			TRN	/* 임시운행기관 */
			, BUSI_NM	/* 분야 */
			, COUNT(TRN) AS CNT	/* 운행대수 */
			, SUM(LAST_TOTAL_DRIVING_DIST) AS LAST_TOTAL_DRIVING_DIST	/* 전반기까지(누적) : 총주행거리*/
			, SUM(LAST_AUTO_DRIVING_DIST) AS LAST_AUTO_DRIVING_DIST	/* 전반기까지(누적) : 자율모드 */
			, SUM(LAST_NOMAL_DRIVING_DIST)	AS LAST_NOMAL_DRIVING_DIST	/* 전반기까지(누적) : 일반모드 */
			, SUM(LAST_TOTAL_CTR_CHANGE_CNT) AS LAST_TOTAL_CTR_CHANGE_CNT	/* 전반기까지(누적) : 제어권 전환 */
			, SUM(TOTAL_DRIVING_DIST) AS TOTAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 총주행거리 */
			, SUM(AUTO_DRIVING_DIST) AS AUTO_DRIVING_DIST	/* 해당년도 반기 주행거리 : 자율모드 */
			, SUM(NOMAL_DRIVING_DIST) AS NOMAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 일반모드 */
			, SUM(AUTO_DRIVING_DIST_1) AS AUTO_DRIVING_DIST_1
			, SUM(AUTO_DRIVING_DIST_2) AS AUTO_DRIVING_DIST_2
			, SUM(AUTO_DRIVING_DIST_3) AS AUTO_DRIVING_DIST_3
			, SUM(AUTO_DRIVING_DIST_4) AS AUTO_DRIVING_DIST_4
			, SUM(AUTO_DRIVING_DIST_5) AS AUTO_DRIVING_DIST_5
			, SUM(AUTO_DRIVING_DIST_6) AS AUTO_DRIVING_DIST_6
			, SUM(AUTO_DRIVING_SUM) AS AUTO_DRIVING_SUM
			, SUM(CTR_CHANGE_CNT_1) AS CTR_CHANGE_CNT_1
			, SUM(CTR_CHANGE_CNT_2) AS CTR_CHANGE_CNT_2
			, SUM(CTR_CHANGE_CNT_3) AS CTR_CHANGE_CNT_3
			, SUM(CTR_CHANGE_CNT_4) AS CTR_CHANGE_CNT_4
			, SUM(CTR_CHANGE_CNT_5) AS CTR_CHANGE_CNT_5
			, SUM(CTR_CHANGE_CNT_6) AS CTR_CHANGE_CNT_6
			, SUM(CTR_CHANGE_SUM) AS CTR_CHANGE_SUM
		FROM TBL
		GROUP BY TRN
	</select>
	
	<!-- 보고서 통계 : 분야 기준 -->
	<select id="ReportStatNewDAO.selectReportStatNewListByBusi" parameterClass="paramMap" resultClass="egovMap">
		<!-- WITH는 위와 똑같으면 됨 -->
		WITH TBL AS
		(
			<![CDATA[
			SELECT
				FN_CT_GET_AGENCY_NAME(B.USER_ID) AS TRN	/* 임시운행기관 */
				, A.TMP_RACE_NUMBER						/* 임시운행등록번호 */
				, B.BUSI_CD	/* 분야코드 */
				, B.BUSI_NM	/* 분야명 */
				, C.TOTAL_DRIVING_DIST LAST_TOTAL_DRIVING_DIST	/* 전반기까지(누적) : 총주행거리*/
				, C.AUTO_DRIVING_DIST LAST_AUTO_DRIVING_DIST	/* 전반기까지(누적) : 자율모드 */
				, C.NOMAL_DRIVING_DIST LAST_NOMAL_DRIVING_DIST	/* 전반기까지(누적) : 일반모드 */
				, D.LAST_TOTAL_CTR_CHANGE_CNT 	/* 전반기까지(누적) : 제어권 전환 */
				, E.TOTAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 총주행거리 */
				, E.AUTO_DRIVING_DIST	/* 해당년도 반기 주행거리 : 자율모드 */
				, E.NOMAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 일반모드 */
				, F.AUTO_DRIVING_DIST_1
				, F.AUTO_DRIVING_DIST_2
				, F.AUTO_DRIVING_DIST_3
				, F.AUTO_DRIVING_DIST_4
				, F.AUTO_DRIVING_DIST_5
				, F.AUTO_DRIVING_DIST_6
				, F.AUTO_DRIVING_DIST_1 + F.AUTO_DRIVING_DIST_2 + F.AUTO_DRIVING_DIST_3 + F.AUTO_DRIVING_DIST_4 + F.AUTO_DRIVING_DIST_5 + F.AUTO_DRIVING_DIST_6 AS AUTO_DRIVING_SUM
				, G.CTR_CHANGE_CNT_1
				, G.CTR_CHANGE_CNT_2
				, G.CTR_CHANGE_CNT_3
				, G.CTR_CHANGE_CNT_4
				, G.CTR_CHANGE_CNT_5
				, G.CTR_CHANGE_CNT_6
				, G.CTR_CHANGE_CNT_1 + G.CTR_CHANGE_CNT_2 + G.CTR_CHANGE_CNT_3 + G.CTR_CHANGE_CNT_4 + G.CTR_CHANGE_CNT_5 + G.CTR_CHANGE_CNT_6 AS CTR_CHANGE_SUM
			FROM
				TB_CL_HT_DRIVING A
			INNER JOIN
				TB_CM_HT_TEMPOPER B
			ON
				A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
			
			/* 전반기까지(누적) : 총주행거리, 자율모드, 일반모드 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
					, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
					, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
				FROM
					TB_CL_HT_DRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
				GROUP BY A.TMP_RACE_NUMBER
			) C
			ON A.TMP_RACE_NUMBER = C.TMP_RACE_NUMBER
			
			/* 전반기까지(누적) : 제어권 전환 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CTR_CHANGE_CNT) LAST_TOTAL_CTR_CHANGE_CNT
				FROM
					TB_CL_HT_CTRCHANGE A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(DATE_FORMAT(A.STND_DT, '%Y%m%d'), 9999) < CONCAT('$sKeyword$$sTerm$', '01')
				GROUP BY A.TMP_RACE_NUMBER
			) D
			ON A.TMP_RACE_NUMBER = D.TMP_RACE_NUMBER
			
			/* 해당년도 반기 주행거리 : 총주행거리, 자율모드, 일반모드 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(A.TOTAL_DRIVING_DIST) TOTAL_DRIVING_DIST
					, SUM(A.AUTO_DRIVING_DIST) AUTO_DRIVING_DIST
					, SUM(A.NOMAL_DRIVING_DIST) NOMAL_DRIVING_DIST
				FROM
					TB_CL_HT_DRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
				GROUP BY A.TMP_RACE_NUMBER
			) E
			ON A.TMP_RACE_NUMBER = E.TMP_RACE_NUMBER
			
			/* 해당년도 반기  : 월별 자율주행 주행거리 */
			LEFT OUTER JOIN
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____01' OR DRIVING_DIST_MON LIKE '____07' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_1
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____02' OR DRIVING_DIST_MON LIKE '____08' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_2
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____03' OR DRIVING_DIST_MON LIKE '____09' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_3
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____04' OR DRIVING_DIST_MON LIKE '____10' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_4
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____05' OR DRIVING_DIST_MON LIKE '____11' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_5
					, SUM(CASE WHEN DRIVING_DIST_MON LIKE '____06' OR DRIVING_DIST_MON LIKE '____12' THEN AUTO_DRIVING_DIST END) AUTO_DRIVING_DIST_6
				FROM
					TB_CL_HT_AUTODRIVING A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
				GROUP BY A.TMP_RACE_NUMBER
			) F
			ON A.TMP_RACE_NUMBER = F.TMP_RACE_NUMBER
			
			/* 해당년도 반기  : 제어권 전환 횟수 */
			LEFT OUTER JOIN 
			(
				SELECT
					A.TMP_RACE_NUMBER
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____01' OR CTR_CHANGE_MON LIKE '____07' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_1
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____02' OR CTR_CHANGE_MON LIKE '____08' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_2
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____03' OR CTR_CHANGE_MON LIKE '____09' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_3
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____04' OR CTR_CHANGE_MON LIKE '____10' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_4
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____05' OR CTR_CHANGE_MON LIKE '____11' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_5
					, SUM(CASE WHEN CTR_CHANGE_MON LIKE '____06' OR CTR_CHANGE_MON LIKE '____12' THEN CTR_CHANGE_CNT END) CTR_CHANGE_CNT_6
				FROM
					TB_CL_HT_CTRCHANGE A
				INNER JOIN
					TB_CM_HT_TEMPOPER B
				ON
					A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER	
				WHERE
					1=1
					AND IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) = '$sKeyword$$sTerm$'
					GROUP BY A.TMP_RACE_NUMBER
			) G
			ON
				A.TMP_RACE_NUMBER = G.TMP_RACE_NUMBER
			WHERE
				IFNULL(CONCAT(DATE_FORMAT(A.STND_DT, '%Y'), (CASE WHEN MONTH(A.STND_DT) <= 6 THEN '01' WHEN MONTH(A.STND_DT) >= 7 THEN '07' ELSE -1 END)), -1) <= '$sKeyword$$sTerm$'
			]]>
			<isNotEmpty property="sTmpRaceAgency">
				AND A.TMP_RACE_AGENCY LIKE '%$sTmpRaceAgency$%'
			</isNotEmpty>
			<isNotEmpty property="sTmpRaceNumber">
				AND A.TMP_RACE_NUMBER LIKE '%$sTmpRaceNumber$%'
			</isNotEmpty>
			GROUP BY TRN, A.TMP_RACE_NUMBER
			ORDER BY A.TMP_RACE_NUMBER
		)
		SELECT
			BUSI_CD
			, BUSI_NM /* 분야 */
			, COUNT(BUSI_CD) AS CNT	/* 운행대수 */
			, COUNT(DISTINCT(TRN)) AS TRN_CNT	/* 업체수 */
			, SUM(LAST_TOTAL_DRIVING_DIST) AS LAST_TOTAL_DRIVING_DIST	/* 전반기까지(누적) : 총주행거리*/
			, SUM(LAST_AUTO_DRIVING_DIST) AS LAST_AUTO_DRIVING_DIST	/* 전반기까지(누적) : 자율모드 */
			, SUM(LAST_NOMAL_DRIVING_DIST)	AS LAST_NOMAL_DRIVING_DIST	/* 전반기까지(누적) : 일반모드 */
			, SUM(LAST_TOTAL_CTR_CHANGE_CNT) AS LAST_TOTAL_CTR_CHANGE_CNT	/* 전반기까지(누적) : 제어권 전환 */
			, SUM(TOTAL_DRIVING_DIST) AS TOTAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 총주행거리 */
			, SUM(AUTO_DRIVING_DIST) AS AUTO_DRIVING_DIST	/* 해당년도 반기 주행거리 : 자율모드 */
			, SUM(NOMAL_DRIVING_DIST) AS NOMAL_DRIVING_DIST	/* 해당년도 반기 주행거리 : 일반모드 */
			, SUM(AUTO_DRIVING_DIST_1) AS AUTO_DRIVING_DIST_1
			, SUM(AUTO_DRIVING_DIST_2) AS AUTO_DRIVING_DIST_2
			, SUM(AUTO_DRIVING_DIST_3) AS AUTO_DRIVING_DIST_3
			, SUM(AUTO_DRIVING_DIST_4) AS AUTO_DRIVING_DIST_4
			, SUM(AUTO_DRIVING_DIST_5) AS AUTO_DRIVING_DIST_5
			, SUM(AUTO_DRIVING_DIST_6) AS AUTO_DRIVING_DIST_6
			, SUM(AUTO_DRIVING_SUM) AS AUTO_DRIVING_SUM
			, SUM(CTR_CHANGE_CNT_1) AS CTR_CHANGE_CNT_1
			, SUM(CTR_CHANGE_CNT_2) AS CTR_CHANGE_CNT_2
			, SUM(CTR_CHANGE_CNT_3) AS CTR_CHANGE_CNT_3
			, SUM(CTR_CHANGE_CNT_4) AS CTR_CHANGE_CNT_4
			, SUM(CTR_CHANGE_CNT_5) AS CTR_CHANGE_CNT_5
			, SUM(CTR_CHANGE_CNT_6) AS CTR_CHANGE_CNT_6
			, SUM(CTR_CHANGE_SUM) AS CTR_CHANGE_SUM
		FROM TBL
		GROUP BY BUSI_CD
	</select>
</sqlMap>
